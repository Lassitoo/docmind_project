{% extends 'base.html' %}

{% block title %}Résultat de Comparaison - DocMind{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .comparison-container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
    }

    .comparison-header {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .header-title h1 {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .processing-time {
        background: #f8f9fa;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 0.9rem;
    }

    .documents-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .document-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .document-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
    }

    .document-card.doc1::before {
        background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
    }

    .document-card.doc2::before {
        background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%);
    }

    .doc-card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    .doc-card-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .doc-card-icon.doc1 {
        background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
    }

    .doc-card-icon.doc2 {
        background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%);
    }

    .doc-card-title {
        flex: 1;
    }

    .doc-card-title h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .doc-card-title small {
        color: #999;
    }

    .doc-stats {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }

    .stat-item {
        flex: 1;
        text-align: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #11998e;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #666;
        margin-top: 5px;
    }

    /* Résultats de comparaison */
    .comparison-results {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .results-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #f0f0f0;
    }

    .results-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
    }

    .results-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
    }

    .analysis-content {
        line-height: 1.8;
        color: #444;
        font-size: 1rem;
    }

    .analysis-content h1,
    .analysis-content h2,
    .analysis-content h3 {
        color: #11998e;
        margin-top: 30px;
        margin-bottom: 15px;
        font-weight: 700;
    }

    .analysis-content h1 {
        font-size: 1.8rem;
        border-bottom: 3px solid #11998e;
        padding-bottom: 10px;
    }

    .analysis-content h2 {
        font-size: 1.5rem;
    }

    .analysis-content h3 {
        font-size: 1.2rem;
    }

    .analysis-content strong {
        color: #11998e;
        font-weight: 600;
    }

    .analysis-content ul,
    .analysis-content ol {
        margin: 15px 0;
        padding-left: 30px;
    }

    .analysis-content li {
        margin-bottom: 10px;
    }

    .analysis-content p {
        margin-bottom: 15px;
    }

    .analysis-content code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        color: #e83e8c;
        font-size: 0.9em;
    }

    .analysis-content blockquote {
        border-left: 4px solid #11998e;
        padding-left: 20px;
        margin: 20px 0;
        color: #666;
        font-style: italic;
    }

    /* Badges pour les différences */
    .difference-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 10px;
    }

    .badge-major {
        background: #ff6b6b;
        color: white;
    }

    .badge-minor {
        background: #ffd93d;
        color: #333;
    }

    .badge-added {
        background: #51cf66;
        color: white;
    }

    .badge-removed {
        background: #ff6b6b;
        color: white;
    }

    /* Actions */
    .comparison-actions {
        margin-top: 30px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 5px 20px rgba(17, 153, 142, 0.3);
    }

    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
    }

    .btn-secondary-custom {
        background: white;
        color: #11998e;
        border: 2px solid #11998e;
    }

    .btn-secondary-custom:hover {
        background: #11998e;
        color: white;
    }

    .btn-update {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        box-shadow: 0 5px 20px rgba(245, 87, 108, 0.3);
    }

    .btn-update:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(245, 87, 108, 0.4);
    }

    .btn-apply-direct {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 5px 20px rgba(17, 153, 142, 0.3);
        font-weight: 700;
    }

    .btn-apply-direct:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
    }

    .btn-apply-direct:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Type de comparaison */
    .comparison-type {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .type-llm {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .type-simple {
        background: #ffd93d;
        color: #333;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .documents-summary {
            grid-template-columns: 1fr;
        }

        .comparison-results {
            padding: 25px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="comparison-container">
    <!-- Header -->
    <div class="comparison-header">
        <div class="header-content">
            <div class="header-title">
                <h1><i class="bi bi-arrow-left-right"></i> Résultat de la Comparaison</h1>
                <p class="text-muted mb-0">Analyse détaillée des différences entre vos documents</p>
            </div>
            <div class="processing-time">
                <i class="bi bi-stopwatch"></i>
                Temps de traitement: <strong>{{ comparison.processing_time|floatformat:2 }}s</strong>
            </div>
        </div>
    </div>

    <!-- Résumé des documents -->
    <div class="documents-summary">
        <div class="document-card doc1">
            <div class="doc-card-header">
                <div class="doc-card-icon doc1">
                    <i class="bi bi-file-earmark-text-fill"></i>
                </div>
                <div class="doc-card-title">
                    <small>Document 1 - Référence</small>
                    <h3>{{ doc1.title }}</h3>
                </div>
            </div>
            <div class="doc-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ comparison.doc1.word_count|default:"N/A" }}</div>
                    <div class="stat-label">Mots</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        <i class="bi bi-calendar3"></i>
                    </div>
                    <div class="stat-label">{{ doc1.uploaded_at|date:"d/m/Y" }}</div>
                </div>
            </div>
        </div>

        <div class="document-card doc2">
            <div class="doc-card-header">
                <div class="doc-card-icon doc2">
                    <i class="bi bi-file-earmark-text-fill"></i>
                </div>
                <div class="doc-card-title">
                    <small>Document 2 - Comparé</small>
                    <h3>{{ doc2.title }}</h3>
                </div>
            </div>
            <div class="doc-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ comparison.doc2.word_count|default:"N/A" }}</div>
                    <div class="stat-label">Mots</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        <i class="bi bi-calendar3"></i>
                    </div>
                    <div class="stat-label">{{ doc2.uploaded_at|date:"d/m/Y" }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Résultats de la comparaison -->
    <div class="comparison-results">
        <div class="results-header">
            <div class="results-icon">
                <i class="bi bi-search"></i>
            </div>
            <div>
                <h2>Analyse Comparative</h2>
                <div class="comparison-type {% if comparison.comparison.type == 'llm' %}type-llm{% else %}type-simple{% endif %}">
                    <i class="bi bi-{% if comparison.comparison.type == 'llm' %}robot{% else %}calculator{% endif %}"></i>
                    {% if comparison.comparison.type == 'llm' %}
                        Analyse IA ({{ comparison.comparison.model }})
                    {% else %}
                        Analyse basique
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="analysis-content">
            {{ comparison.comparison.analysis|linebreaks }}
        </div>

        <div class="comparison-actions">
            <button onclick="applyChangesDirectly()" class="btn-action btn-apply-direct" id="btnApplyDirect">
                <i class="bi bi-check-circle-fill"></i>
                Appliquer les Changements au Document
            </button>
            <button onclick="generateUpdatedDocument()" class="btn-action btn-update" id="btnUpdate">
                <i class="bi bi-magic"></i>
                Générer Document Mis à Jour
            </button>
            <a href="{% url 'chat:documents_comparison_download_pdf' %}" class="btn-action btn-primary-custom">
                <i class="bi bi-file-earmark-pdf"></i>
                Télécharger Rapport PDF
            </a>
            <a href="{% url 'chat:documents_compare_select' %}" class="btn-action btn-secondary-custom">
                <i class="bi bi-arrow-repeat"></i>
                Nouvelle Comparaison
            </a>
            <button onclick="window.print()" class="btn-action btn-secondary-custom">
                <i class="bi bi-printer"></i>
                Imprimer
            </button>
            <button onclick="copyToClipboard()" class="btn-action btn-secondary-custom">
                <i class="bi bi-clipboard"></i>
                Copier
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    /* Modal pour le document mis à jour */
    .modal-update {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .modal-update.active {
        display: flex;
    }

    .modal-content-update {
        background: white;
        border-radius: 20px;
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .modal-header-update {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header-update h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .modal-body-update {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
    }

    .updated-document-content {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #e0e0e0;
    }

    .update-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .modal-footer-update {
        padding: 20px 30px;
        background: #f8f9fa;
        border-top: 2px solid #e0e0e0;
        display: flex;
        gap: 15px;
        justify-content: flex-end;
    }

    .processing-indicator {
        text-align: center;
        padding: 40px;
    }

    .spinner-large {
        width: 80px;
        height: 80px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #f5576c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .highlight-modified {
        background: #fff3cd;
        padding: 2px 5px;
        border-radius: 3px;
    }

    .highlight-added {
        background: #d4edda;
        padding: 2px 5px;
        border-radius: 3px;
    }
</style>

<script>
// Stocker les IDs des documents
const doc1Id = {{ doc1.id }};
const doc2Id = {{ doc2.id }};

function copyToClipboard() {
    const analysisText = $('.analysis-content').text();
    navigator.clipboard.writeText(analysisText).then(function() {
        showNotification('Analyse copiée dans le presse-papiers!', 'success');
    }, function(err) {
        console.error('Erreur lors de la copie:', err);
        showNotification('Erreur lors de la copie', 'error');
    });
}

function applyChangesDirectly() {
    // Confirmation de l'utilisateur
    if (!confirm('⚠️ ATTENTION ⚠️\n\nCette action va modifier directement le Document 1 "{{ doc1.title }}" dans la base de données en appliquant les changements du Document 2.\n\nLe contenu original sera remplacé de manière permanente.\n\nVoulez-vous continuer ?')) {
        return;
    }

    const button = $('#btnApplyDirect');
    const originalHtml = button.html();

    // Désactiver le bouton et afficher le chargement
    button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Application en cours...');

    // Appel AJAX pour appliquer les changements
    $.ajax({
        url: '{% url "chat:documents_apply_changes" %}',
        type: 'POST',
        data: {
            'doc1_id': doc1Id,
            'doc2_id': doc2Id,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                showSuccessModal(response);
            } else {
                showNotification('Erreur: ' + (response.error || 'Erreur inconnue'), 'error');
                button.prop('disabled', false).html(originalHtml);
            }
        },
        error: function(xhr) {
            let errorMsg = 'Erreur de connexion au serveur';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            showNotification('Erreur: ' + errorMsg, 'error');
            button.prop('disabled', false).html(originalHtml);
        }
    });
}

function showSuccessModal(response) {
    const docId = response.document_id;
    const downloadPdfUrl = '/chat/download-updated/' + docId + '/pdf/';
    const downloadTxtUrl = '/chat/download-updated/' + docId + '/txt/';
    const downloadOriginalUrl = '/chat/download-updated/' + docId + '/original/';
    const fileModified = response.file_modified || false;
    const hasFile = response.has_file || false;

    // Message d'information selon le type de modification
    let infoMessage = '';
    if (fileModified && hasFile) {
        infoMessage = '<li>✅ Le fichier original a été modifié en préservant sa structure (tableaux, styles, mise en page)</li>' +
                     '<li>✅ Les changements ont été appliqués directement sans marqueurs</li>' +
                     '<li>✅ Vous pouvez télécharger le fichier original modifié ci-dessous</li>';
    } else {
        infoMessage = '<li>✅ Le contenu texte a été mis à jour dans la base de données</li>' +
                     '<li>✅ Les changements ont été appliqués directement sans marqueurs</li>' +
                     '<li>⚠️ La structure originale du fichier n\'a pas pu être préservée (format non supporté ou fichier absent)</li>';
    }

    // Construire les boutons de téléchargement
    let downloadButtons = '';
    if (fileModified && hasFile) {
        downloadButtons = '<a href="' + downloadOriginalUrl + '" class="btn-action btn-primary-custom" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">' +
                             '<i class="bi bi-file-earmark-check"></i> Télécharger Fichier Original Modifié' +
                         '</a>' +
                         '<a href="' + downloadPdfUrl + '" class="btn-action btn-secondary-custom">' +
                             '<i class="bi bi-file-earmark-pdf"></i> PDF (texte)' +
                         '</a>' +
                         '<a href="' + downloadTxtUrl + '" class="btn-action btn-secondary-custom">' +
                             '<i class="bi bi-file-earmark-text"></i> TXT' +
                         '</a>';
    } else {
        downloadButtons = '<a href="' + downloadPdfUrl + '" class="btn-action btn-primary-custom" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">' +
                             '<i class="bi bi-file-earmark-pdf"></i> Télécharger PDF' +
                         '</a>' +
                         '<a href="' + downloadTxtUrl + '" class="btn-action btn-secondary-custom">' +
                             '<i class="bi bi-file-earmark-text"></i> Télécharger TXT' +
                         '</a>';
    }

    const modal = $('<div class="modal-update active" id="successModal">' +
        '<div class="modal-content-update">' +
            '<div class="modal-header-update" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">' +
                '<h3><i class="bi bi-check-circle-fill"></i> Mise à Jour Réussie</h3>' +
                '<button class="modal-close" onclick="closeSuccessModal()">&times;</button>' +
            '</div>' +
            '<div class="modal-body-update">' +
                '<div class="update-info" style="background: #d4edda; border-left: 4px solid #28a745;">' +
                    '<strong><i class="bi bi-check-circle"></i> Succès</strong><br>' +
                    response.message + '<br><br>' +
                    '<strong>Document mis à jour:</strong> ' + response.document_title + '<br>' +
                    '<strong>Nombre de mots:</strong> ' + response.updated_word_count + '<br>' +
                    '<strong>Temps de traitement:</strong> ' + response.processing_time.toFixed(2) + 's' +
                '</div>' +
                '<div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px;">' +
                    '<h4 style="color: #11998e; margin-bottom: 15px;"><i class="bi bi-info-circle"></i> Que s\'est-il passé ?</h4>' +
                    '<ul style="line-height: 2; color: #555;">' +
                        infoMessage +
                        '<li>✅ Le document est maintenant disponible dans votre liste de documents</li>' +
                    '</ul>' +
                '</div>' +
                '<div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-radius: 10px; border: 2px solid #667eea;">' +
                    '<h4 style="color: #667eea; margin-bottom: 15px;"><i class="bi bi-download"></i> Télécharger le Document Mis à Jour</h4>' +
                    '<div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">' +
                        downloadButtons +
                    '</div>' +
                '</div>' +
                '<div class="modal-footer-update">' +
                    '<a href="{% url "documents:list" %}" class="btn-action btn-primary-custom">' +
                        '<i class="bi bi-folder-open"></i> Voir Mes Documents' +
                    '</a>' +
                    '<a href="{% url "chat:documents_compare_select" %}" class="btn-action btn-secondary-custom">' +
                        '<i class="bi bi-arrow-repeat"></i> Nouvelle Comparaison' +
                    '</a>' +
                    '<button onclick="closeSuccessModal()" class="btn-action btn-secondary-custom">' +
                        'Fermer' +
                    '</button>' +
                '</div>' +
            '</div>' +
        '</div>' +
    '</div>');

    $('body').append(modal);
}

function closeSuccessModal() {
    $('#successModal').remove();
    // Recharger la page pour refléter les changements
    location.reload();
}

function generateUpdatedDocument() {
    // Créer et afficher la modal
    const modal = $('<div class="modal-update active" id="updateModal">' +
        '<div class="modal-content-update">' +
            '<div class="modal-header-update">' +
                '<h3><i class="bi bi-magic"></i> Génération du Document Mis à Jour</h3>' +
                '<button class="modal-close" onclick="closeUpdateModal()">&times;</button>' +
            '</div>' +
            '<div class="modal-body-update">' +
                '<div class="processing-indicator">' +
                    '<div class="spinner-large"></div>' +
                    '<h4>Analyse en cours...</h4>' +
                    '<p>L\'IA fusionne les documents et génère la version mise à jour</p>' +
                '</div>' +
            '</div>' +
        '</div>' +
    '</div>');

    $('body').append(modal);

    // Appel AJAX pour générer le document
    $.ajax({
        url: '{% url "chat:documents_update_generate" %}',
        type: 'POST',
        data: {
            'doc1_id': doc1Id,
            'doc2_id': doc2Id,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                displayUpdatedDocument(response);
            } else {
                showError(response.error || 'Erreur lors de la génération');
            }
        },
        error: function(xhr) {
            showError('Erreur de connexion au serveur');
        }
    });
}

function displayUpdatedDocument(response) {
    const content = response.updated_content.content;
    const type = response.updated_content.type;
    const message = response.updated_content.message;
    const processingTime = response.processing_time;

    // Mise en évidence des sections modifiées
    let highlightedContent = content
        .replace(/\[MODIFIÉ\]/g, '<span class="highlight-modified">[MODIFIÉ]</span>')
        .replace(/\[AJOUTÉ\]/g, '<span class="highlight-added">[AJOUTÉ]</span>');

    const modalBody = $('#updateModal .modal-body-update');
    modalBody.html(`
        <div class="update-info">
            <strong><i class="bi bi-info-circle"></i> Information</strong><br>
            ${message}<br>
            <small>Temps de traitement: ${processingTime.toFixed(2)}s</small>
        </div>
        <div class="updated-document-content">${highlightedContent}</div>
        <div class="modal-footer-update">
            <button onclick="copyUpdatedDocument()" class="btn-action btn-secondary-custom">
                <i class="bi bi-clipboard"></i> Copier
            </button>
            <a href="{% url 'chat:documents_update_download_pdf' %}" class="btn-action btn-primary-custom" target="_blank">
                <i class="bi bi-file-earmark-pdf"></i> Télécharger PDF
            </a>
            <a href="{% url 'chat:documents_update_download' %}" class="btn-action btn-secondary-custom" target="_blank">
                <i class="bi bi-file-text"></i> Télécharger TXT
            </a>
            <button onclick="closeUpdateModal()" class="btn-action btn-secondary-custom">
                Fermer
            </button>
        </div>
    `);

    // Stocker le contenu pour la copie
    window.updatedDocumentContent = content;
}

function copyUpdatedDocument() {
    if (window.updatedDocumentContent) {
        navigator.clipboard.writeText(window.updatedDocumentContent).then(function() {
            showNotification('Document mis à jour copié!', 'success');
        });
    }
}

function closeUpdateModal() {
    $('#updateModal').remove();
}

function showError(message) {
    const modalBody = $('#updateModal .modal-body-update');
    modalBody.html(`
        <div class="alert alert-danger" style="margin: 20px;">
            <i class="bi bi-exclamation-triangle"></i> <strong>Erreur</strong><br>
            ${message}
        </div>
        <div class="modal-footer-update">
            <button onclick="closeUpdateModal()" class="btn-action btn-secondary-custom">
                Fermer
            </button>
        </div>
    `);
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show"
             style="position: fixed; top: 20px; right: 20px; z-index: 10001; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);

    $('body').append(notification);

    setTimeout(function() {
        notification.fadeOut(function() {
            $(this).remove();
        });
    }, 3000);
}

// Auto-scroll smooth au chargement
$(document).ready(function() {
    $('html, body').animate({
        scrollTop: 0
    }, 500);
});
</script>
{% endblock %}
