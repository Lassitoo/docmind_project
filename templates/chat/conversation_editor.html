{#template_name: conversation_editor.html#}
{% extends 'base.html' %}

{% block title %}{{ conversation.title }} - √âditeur DocMind{% endblock %}

{% block extra_css %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    /* Design tokens minimaliste */
    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --text-tertiary: #9ca3af;
        --border-light: #e5e7eb;
        --border-medium: #d1d5db;
        --accent-primary: #3b82f6;
        --accent-hover: #2563eb;
        --success: #10b981;
        --error: #ef4444;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    /* Reset base */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    main {
        padding: 0 !important;
        height: calc(100vh - 56px);
        overflow: hidden;
        position: relative;
    }

    .editor-wrapper {
        display: flex;
        height: 100%;
        width: 100%;
        background: var(--bg-secondary);
    }

    /* Toolbar simplifi√©e et √©pur√©e */
    .editor-toolbar {
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        height: 56px;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 24px;
        gap: 20px;
    }

    .editor-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .editor-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    /* Boutons minimalistes sans gradient */
    .btn-editor {
        background: var(--accent-primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
    }

    .btn-editor:hover {
        background: var(--accent-hover);
        box-shadow: var(--shadow-sm);
    }

    .btn-editor:active {
        transform: scale(0.98);
    }

    .btn-editor-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-light);
    }

    .btn-editor-secondary:hover {
        background: var(--bg-secondary);
        border-color: var(--border-medium);
    }

    .btn-editor-success {
        background: var(--success);
    }

    .btn-editor-success:hover {
        background: #059669;
    }

    .toolbar-divider {
        width: 1px;
        height: 24px;
        background: var(--border-light);
    }

    /* Zone principale */
    .editor-main {
        display: flex;
        flex: 1;
        margin-top: 56px;
        height: calc(100% - 56px);
    }

    /* Sidebars plus √©pur√©es */
    .editor-sidebar-left {
        width: 320px;
        background: var(--bg-primary);
        border-right: 1px solid var(--border-light);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sidebar-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-light);
        background: var(--bg-secondary);
    }

    .sidebar-tab {
        flex: 1;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        border-bottom: 2px solid transparent;
    }

    .sidebar-tab:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .sidebar-tab.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
        background: var(--bg-primary);
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .sidebar-tab-panel {
        display: none;
    }

    .sidebar-tab-panel.active {
        display: block;
    }

    /* Agent IA Panel */
    .agent-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .agent-panel h6 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .agent-panel > p {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin: 0 0 12px 0;
        line-height: 1.4;
    }

    .agent-chat {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0;
        max-height: 400px;
    }

    .agent-message {
        background: var(--bg-secondary);
        padding: 12px;
        border-radius: 8px;
        border-left: 3px solid var(--accent-primary);
        font-size: 0.85rem;
    }

    .agent-message strong {
        color: var(--accent-primary);
        display: block;
        margin-bottom: 4px;
    }

    .agent-message p {
        margin: 0;
        color: var(--text-primary);
        line-height: 1.4;
    }

    .agent-input-container {
        display: flex;
        gap: 8px;
    }

    .agent-input {
        flex: 1;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.85rem;
        font-family: inherit;
        resize: none;
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .agent-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    /* Documents Panel */
    .documents-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .document-item {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85rem;
    }

    .document-item:hover {
        border-color: var(--accent-primary);
        background: var(--bg-tertiary);
    }

    .document-item.active {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    .document-icon {
        font-size: 1.4rem;
        opacity: 0.7;
    }

    .document-item.active .document-icon {
        opacity: 1;
    }

    .document-info h6 {
        margin: 0;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .document-info small {
        opacity: 0.7;
        font-size: 0.75rem;
    }

    /* Zone d'√©dition centrale */
    .editor-canvas {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg-secondary);
        padding: 16px;
    }

    /* Mode selector √©pur√© */
    .editor-mode-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        justify-content: center;
    }

    .mode-btn {
        padding: 8px 16px;
        background: var(--bg-primary);
        border: 1px solid var(--border-light);
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-primary);
    }

    .mode-btn:hover {
        border-color: var(--accent-primary);
        background: var(--bg-secondary);
    }

    .mode-btn.active {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
    }

    /* √âditeur Quill */
    .quill-editor-container {
        flex: 1;
        background: var(--bg-primary);
        border-radius: 8px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    #editor {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        font-size: 15px;
        line-height: 1.6;
        color: var(--text-primary);
    }

    .ql-toolbar {
        background: var(--bg-secondary) !important;
        border: none !important;
        border-bottom: 1px solid var(--border-light) !important;
        padding: 12px !important;
    }

    .ql-toolbar button {
        color: var(--text-secondary);
    }

    .ql-toolbar button:hover,
    .ql-toolbar button.ql-active {
        color: var(--accent-primary) !important;
    }

    .ql-container {
        border: none !important;
        font-family: inherit;
    }

    /* Canvas Fabric */
    .fabric-canvas-container {
        flex: 1;
        background: var(--bg-secondary);
        border-radius: 8px;
        box-shadow: var(--shadow-md);
        overflow: auto;
        padding: 24px;
        display: none;
        min-height: 100%;
        max-height: 100%;
    }

    .fabric-canvas-container.active {
        display: block;
    }

    .fabric-canvas-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100%;
    }

    #fabricCanvas {
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-md);
        background: var(--bg-primary);
    }

    /* Sidebar droite */
    .editor-sidebar-right {
        width: 280px;
        background: var(--bg-primary);
        border-left: 1px solid var(--border-light);
        overflow-y: auto;
        padding: 16px;
    }

    .properties-section {
        margin-bottom: 20px;
    }

    .properties-section h6 {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
        margin: 0 0 12px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .property-control {
        margin-bottom: 12px;
    }

    .property-control label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
        display: block;
        margin-bottom: 4px;
    }

    .property-control input,
    .property-control select {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        font-size: 0.875rem;
        font-family: inherit;
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .property-control input:focus,
    .property-control select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .color-picker-row {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .color-picker-row input[type="color"] {
        width: 44px;
        height: 36px;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        cursor: pointer;
    }

    /* Indicateur de sauvegarde */
    .save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 16px;
        background: var(--bg-primary);
        border-radius: 6px;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 2000;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .save-indicator.show {
        opacity: 1;
        transform: translateY(0);
    }

    .save-indicator.saving {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fcd34d;
    }

    .save-indicator.saved {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .save-indicator.error {
        background: #fee2e2;
        color: #7f1d1d;
        border: 1px solid #fca5a5;
    }

    /* Scrollbars √©pur√©es */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--border-medium);
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--border-medium);
    }

    /* Responsive */
    @media (max-width: 1400px) {
        .editor-sidebar-right {
            width: 260px;
        }
    }

    @media (max-width: 1200px) {
        .editor-sidebar-left {
            width: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-wrapper">
    <!-- Barre d'outils sup√©rieure -->
    <div class="editor-toolbar">
        <div class="editor-title">
            <i class="bi bi-pencil-square"></i>
            <span id="documentTitle">{{ document.title }}</span>
        </div>

        <div class="editor-actions">
            <button class="btn-editor btn-editor-secondary" id="undoBtn" title="Annuler">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <button class="btn-editor btn-editor-secondary" id="redoBtn" title="Refaire">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <div class="toolbar-divider"></div>
            <button class="btn-editor btn-editor-secondary" id="reloadBtn" title="Recharger le contenu depuis le serveur">
                <i class="bi bi-arrow-repeat"></i> Recharger
            </button>
            <button class="btn-editor btn-editor-secondary" id="exportBtn">
                <i class="bi bi-download"></i> Exporter
            </button>
            <button class="btn-editor btn-editor-success" id="saveBtn">
                <i class="bi bi-save"></i> Sauvegarder
            </button>
            <button class="btn-editor btn-editor-secondary" onclick="window.location.href='{% url 'chat:conversation_detail' conversation.id %}'">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>
    </div>

    <!-- Zone principale -->
    <div class="editor-main">
        <!-- Sidebar gauche -->
        <div class="editor-sidebar-left">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" data-tab="agent">
                    <i class="bi bi-robot"></i> Agent
                </div>
                <div class="sidebar-tab" data-tab="documents">
                    <i class="bi bi-files"></i> Documents
                </div>
            </div>

            <div class="sidebar-content">
                <!-- Panneau Agent IA -->
                <div class="sidebar-tab-panel active" id="agentPanel">
                    <div class="agent-panel">
                        <h6><i class="bi bi-magic"></i> Assistant</h6>
                        <p>D√©crivez les modifications √† apporter √† votre document.</p>

                        <div class="agent-chat" id="agentChat">
                            <div class="agent-message">
                                <strong>ü§ñ DocMind</strong>
                                <p>Bonjour ! Que puis-je vous aider ?</p>
                            </div>
                        </div>

                        <div class="agent-input-container">
                            <textarea class="agent-input" id="agentInput" rows="3"
                                      placeholder="Ex: Mets en gras les titres..."></textarea>
                            <button class="btn-editor" id="agentSendBtn" style="height: fit-content;">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panneau Documents -->
                <div class="sidebar-tab-panel" id="documentsPanel">
                    <h6 style="margin-top: 0;"><i class="bi bi-files"></i> Documents</h6>
                    <div class="documents-list">
                        {% for doc in all_documents %}
                        <div class="document-item {% if doc.id == document.id %}active{% endif %}"
                             data-doc-id="{{ doc.id }}"
                             onclick="loadDocument({{ doc.id }})">
                            <i class="bi bi-file-earmark-pdf-fill document-icon"></i>
                            <div class="document-info">
                                <h6>{{ doc.title|truncatechars:25 }}</h6>
                                <small>{{ doc.upload_date|date:"d/m/Y" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Zone d'√©dition centrale -->
        <div class="editor-canvas">
            <!-- S√©lecteur de mode -->
            <div class="editor-mode-selector">
                <button class="mode-btn active" data-mode="text">
                    <i class="bi bi-textarea-t"></i> Texte
                </button>
                <button class="mode-btn" data-mode="visual">
                    <i class="bi bi-palette"></i> Visuel
                </button>
            </div>

            <!-- √âditeur de texte Quill -->
            <div class="quill-editor-container" id="textEditorContainer">
                <div id="editor"></div>
            </div>

            <!-- Canvas visuel Fabric -->
            <div class="fabric-canvas-container" id="visualEditorContainer">
                <div class="fabric-canvas-wrapper">
                    <canvas id="fabricCanvas" width="900" height="1200"></canvas>
                </div>
            </div>
        </div>

        <!-- Sidebar droite -->
        <div class="editor-sidebar-right">
            <div class="properties-section">
                <h6><i class="bi bi-file-text"></i> Document</h6>
                <div class="property-control">
                    <label>Titre</label>
                    <input type="text" id="docTitleInput" value="{{ document.title }}">
                </div>
                <div class="property-control">
                    <label>Pages</label>
                    <input type="text" value="1" readonly>
                </div>
            </div>

            <div class="properties-section">
                <h6><i class="bi bi-type"></i> Texte</h6>
                <div class="property-control">
                    <label>Police</label>
                    <select id="fontSelect">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                    </select>
                </div>
                <div class="property-control">
                    <label>Taille</label>
                    <input type="number" id="fontSizeInput" value="14" min="8" max="72">
                </div>
                <div class="property-control">
                    <label>Couleur</label>
                    <div class="color-picker-row">
                        <input type="color" id="textColorPicker" value="#000000">
                        <input type="text" id="textColorInput" value="#000000" readonly>
                    </div>
                </div>
            </div>

            <div class="properties-section" id="insertionSection">
                <h6><i class="bi bi-image"></i> Insertion</h6>
                <button class="btn-editor" id="insertImageBtn" style="width: 100%; margin-bottom: 8px; font-size: 0.8rem; padding: 8px;">
                    <i class="bi bi-image"></i> Image
                </button>
                <button class="btn-editor btn-editor-secondary" id="insertTableBtn" style="width: 100%; font-size: 0.8rem; padding: 8px;">
                    <i class="bi bi-table"></i> Tableau
                </button>
            </div>

            <div class="properties-section" id="visualToolsSection" style="display: none;">
                <h6><i class="bi bi-tools"></i> Outils</h6>
                <button class="btn-editor" id="addTextBtn" style="width: 100%; margin-bottom: 6px; font-size: 0.8rem; padding: 6px;">
                    <i class="bi bi-fonts"></i> Texte
                </button>
                <button class="btn-editor btn-editor-secondary" id="addRectBtn" style="width: 100%; margin-bottom: 6px; font-size: 0.8rem; padding: 6px;">
                    <i class="bi bi-square"></i> Rectangle
                </button>
                <button class="btn-editor btn-editor-secondary" id="addCircleBtn" style="width: 100%; margin-bottom: 6px; font-size: 0.8rem; padding: 6px;">
                    <i class="bi bi-circle"></i> Cercle
                </button>
                <button class="btn-editor btn-editor-secondary" id="addLineBtn" style="width: 100%; margin-bottom: 6px; font-size: 0.8rem; padding: 6px;">
                    <i class="bi bi-dash"></i> Ligne
                </button>
                <button class="btn-editor" id="deleteObjectBtn" style="width: 100%; background: var(--error); font-size: 0.8rem; padding: 6px;">
                    <i class="bi bi-trash"></i> Supprimer
                </button>
            </div>

            <div class="properties-section" id="objectPropertiesSection" style="display: none;">
                <h6><i class="bi bi-sliders2"></i> Objet</h6>
                <div class="property-control">
                    <label>Position X</label>
                    <input type="number" id="objLeftInput" value="0">
                </div>
                <div class="property-control">
                    <label>Position Y</label>
                    <input type="number" id="objTopInput" value="0">
                </div>
                <div class="property-control">
                    <label>Largeur</label>
                    <input type="number" id="objWidthInput" value="0">
                </div>
                <div class="property-control">
                    <label>Hauteur</label>
                    <input type="number" id="objHeightInput" value="0">
                </div>
                <div class="property-control">
                    <label>Rotation</label>
                    <input type="number" id="objAngleInput" value="0" min="0" max="360">
                </div>
                <div class="property-control">
                    <label>Opacit√© (%)</label>
                    <input type="number" id="objOpacityInput" value="100" min="0" max="100">
                </div>
            </div>

            <div class="properties-section">
                <h6><i class="bi bi-graph-up"></i> Stats</h6>
                <p style="font-size: 0.8rem; margin: 4px 0; color: var(--text-secondary);">
                    <strong>Mots:</strong> <span id="wordCount">0</span>
                </p>
                <p style="font-size: 0.8rem; margin: 4px 0; color: var(--text-secondary);">
                    <strong>Caract√®res:</strong> <span id="charCount">0</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Indicateur de sauvegarde -->
<div class="save-indicator" id="saveIndicator">
    <i class="bi bi-check-circle-fill"></i>
    <span id="saveIndicatorText">Sauvegard√©</span>
</div>

<!-- Input cach√© pour upload d'image -->
<input type="file" id="imageUpload" accept="image/*" style="display: none;">
{% endblock %}

{% block extra_js %}
<!-- Quill.js -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<!-- Variables Django inject√©es -->
<script>
    const DOCUMENT_ID = {{ document.id }};
    const CONVERSATION_ID = {{ conversation.id }};
    const CSRF_TOKEN = '{{ csrf_token }}';

    // URLs
    const URL_EXTRACT = '{% url "chat:extract_document_content" document.id %}';
    const URL_EXTRACT_CONTENT = URL_EXTRACT;
    const URL_SAVE = '{% url "chat:save_document_changes" document.id %}';
    const URL_AUTOSAVE = '{% url "chat:auto_save_document" document.id %}';
    const URL_EXPORT = '{% url "chat:export_document" document.id %}';
    const URL_SEND_MESSAGE = '{% url "chat:send_message" conversation.id %}';
</script>

{% verbatim %}
<script>
$(document).ready(function() {
    let currentMode = 'text';
    let quillEditor = null;
    let fabricCanvas = null;
    let autoSaveInterval = null;
    let documentId = DOCUMENT_ID;
    let conversationId = CONVERSATION_ID;

    initQuillEditor();
    initFabricCanvas();
    loadDocumentContent();
    setupEventListeners();
    startAutoSave();

    function updateStats() {
        const text = quillEditor.getText();
        const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
        const chars = text.length;
        $('#wordCount').text(words);
        $('#charCount').text(chars);
    }

    function updateCanvasStats() {
        const objects = fabricCanvas.getObjects();
        const textObjects = objects.filter(o => o.type === 'textbox' || o.type === 'text');
        let totalText = '';
        textObjects.forEach(obj => {
            totalText += obj.text + ' ';
        });
        const words = totalText.trim().split(/\s+/).filter(w => w.length > 0).length;
        const chars = totalText.length;
        $('#wordCount').text(words);
        $('#charCount').text(chars);
    }

    function showSaveIndicator(text, type) {
        $('#saveIndicatorText').text(text);
        $('#saveIndicator')
            .removeClass('saving saved error')
            .addClass(type)
            .addClass('show');
    }

    function hideSaveIndicator() {
        $('#saveIndicator').removeClass('show');
    }

    function showError(message) {
        try {
            console.error(message);
            showSaveIndicator(message, 'error');
            setTimeout(() => hideSaveIndicator(), 4000);
        } catch (e) {
            alert(message);
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function initQuillEditor() {
        const toolbarOptions = [
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'font': [] }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'align': [] }],
            ['blockquote', 'code-block'],
            ['link', 'image', 'video'],
            ['clean']
        ];

        quillEditor = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions
            },
            placeholder: 'Commencez √† √©crire ou chargez un document...'
        });

        quillEditor.on('text-change', function() {
            updateStats();
        });
    }

    function initFabricCanvas() {
        fabricCanvas = new fabric.Canvas('fabricCanvas', {
            backgroundColor: '#ffffff',
            selection: true,
            preserveObjectStacking: true,
            width: 900,
            height: 1200
        });

        fabricCanvas.on('object:modified', function() {
            showSaveIndicator('Modifications non sauvegard√©es', 'saving');
        });

        fabricCanvas.on('object:added', function() {
            updateCanvasStats();
        });

        fabricCanvas.on('object:removed', function() {
            updateCanvasStats();
        });

        fabricCanvas.on('selection:created', function(e) {
            showObjectProperties(e.selected[0]);
        });

        fabricCanvas.on('selection:updated', function(e) {
            showObjectProperties(e.selected[0]);
        });

        fabricCanvas.on('selection:cleared', function() {
            hideObjectProperties();
        });

        fabric.Object.prototype.transparentCorners = false;
        fabric.Object.prototype.cornerColor = '#3b82f6';
        fabric.Object.prototype.cornerStyle = 'circle';
        fabric.Object.prototype.borderColor = '#3b82f6';
        fabric.Object.prototype.cornerSize = 10;

        document.addEventListener('keydown', function(e) {
            if (currentMode === 'visual') {
                if ((e.key === 'Delete' || e.key === 'Backspace') && fabricCanvas.getActiveObject()) {
                    e.preventDefault();
                    deleteSelectedObject();
                }
            }
        });
    }

    function createBlankCanvas() {
        try {
            if (!fabricCanvas) {
                initFabricCanvas();
            }
            fabricCanvas.clear();
            fabricCanvas.setHeight(1000);
            fabricCanvas.setWidth(695);
            fabricCanvas.setBackgroundColor('#ffffff', fabricCanvas.renderAll.bind(fabricCanvas));

            const hint = new fabric.Textbox('Canvas vide ‚Äî utilisez les outils √† droite pour ajouter du contenu.', {
                left: 50,
                top: 60,
                width: 560,
                fontSize: 14,
                fill: '#9ca3af',
                fontFamily: 'Arial',
                editable: false,
                selectable: false
            });
            fabricCanvas.add(hint);
            fabricCanvas.renderAll();
            showSaveIndicator('Canvas pr√™t', 'saved');
            setTimeout(() => hideSaveIndicator(), 2000);
            updateCanvasStats();
        } catch (e) {
            console.error('Failed to create blank canvas:', e);
        }
    }

    function loadDocumentContent() {
        showSaveIndicator('Chargement...', 'saving');

        $.ajax({
            url: URL_EXTRACT,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: CSRF_TOKEN,
                format: 'quill'
            },
            success: function(response) {
                if (response.success) {
                    if (response.content && response.content.ops) {
                        quillEditor.setContents(response.content);
                    }
                    showSaveIndicator('Document charg√©', 'saved');
                    setTimeout(() => hideSaveIndicator(), 2000);
                    updateStats();
                } else {
                    showSaveIndicator('Erreur: ' + response.error, 'error');
                }
            },
            error: function(xhr) {
                showSaveIndicator('Erreur de chargement', 'error');
                console.error('Erreur:', xhr);
            }
        });
    }

    function loadVisualContent() {
        showSaveIndicator('Chargement...', 'saving');

        $.ajax({
            url: URL_EXTRACT,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: CSRF_TOKEN,
                format: 'fabric'
            },
            success: function(response) {
                if (response.success) {
                    console.log('üì¶ Full response:', response);
                    fabricCanvas.clear();

                    const content = response.content;
                    
                    if (content.objects && Array.isArray(content.objects)) {
                        console.log('üìê Loading saved Fabric canvas with', content.objects.length, 'objects');
                        fabricCanvas.loadFromJSON(content, function() {
                            fabricCanvas.renderAll();
                            console.log('‚úÖ Fabric canvas loaded');
                            showSaveIndicator('Canvas charg√©', 'saved');
                            setTimeout(() => hideSaveIndicator(), 2000);
                            updateCanvasStats();
                        });
                    }
                    else if (content.pages && Array.isArray(content.pages)) {
                        console.log('üìö Loading PDF structure with', content.pages.length, 'pages');
                        
                        let currentY = 50;
                        const pageMargin = 100;
                        let totalObjects = 0;
                        
                        content.pages.forEach((page, pageIndex) => {
                            console.log(`\nüìÑ Page ${pageIndex + 1}:`, page);
                            
                            const pageHeader = new fabric.Text(`Page ${page.page_number}`, {
                                left: 50,
                                top: currentY,
                                fontSize: 10,
                                fill: '#9ca3af',
                                fontFamily: 'Arial',
                                selectable: false
                            });
                            fabricCanvas.add(pageHeader);
                            currentY += 30;
                            
                            if (Array.isArray(page.blocks) && page.blocks.length > 0) {
                                page.blocks.forEach((block, bIndex) => {
                                    const type = (block.type || '').toLowerCase();
                                    if (type === 'heading' || type === 'title' || type === 'h1' || type === 'h2' || type === 'h3') {
                                        const level = block.level || (type === 'h1' ? 1 : type === 'h2' ? 2 : type === 'h3' ? 3 : 2);
                                        const fontSize = level === 1 ? 22 : level === 2 ? 18 : 16;
                                        const text = (block.text || block.content || '').trim();
                                        if (text) {
                                            const hText = new fabric.Textbox(text, {
                                                left: 50,
                                                top: currentY,
                                                fontSize: fontSize,
                                                fontFamily: 'Arial',
                                                fontWeight: 'bold',
                                                fill: '#111827',
                                                width: 500,
                                                selectable: true
                                            });
                                            fabricCanvas.add(hText);
                                            currentY += hText.height + 10;
                                            totalObjects++;
                                        }
                                    }
                                    else if (type === 'paragraph' || type === 'text' || type === 'block') {
                                        const text = (block.text || block.content || '').trim();
                                        if (text) {
                                            const pText = new fabric.Textbox(text, {
                                                left: 50,
                                                top: currentY,
                                                fontSize: 12,
                                                fontFamily: 'Arial',
                                                fill: '#111827',
                                                width: 500,
                                                editable: true
                                            });
                                            fabricCanvas.add(pText);
                                            currentY += pText.height + 8;
                                            totalObjects++;
                                        }
                                    }
                                    else if (type === 'subtitle' || type === 'subheading') {
                                        const text = (block.text || block.content || '').trim();
                                        if (text) {
                                            const sText = new fabric.Textbox(text, {
                                                left: 50,
                                                top: currentY,
                                                fontSize: 16,
                                                fontFamily: 'Arial',
                                                fontWeight: '600',
                                                fill: '#1f2937',
                                                width: 500,
                                                selectable: true
                                            });
                                            fabricCanvas.add(sText);
                                            currentY += sText.height + 8;
                                            totalObjects++;
                                        }
                                    }
                                    else if (type === 'list' || type === 'bullet' || type === 'unordered_list' || type === 'ordered' || type === 'numbered' || type === 'list_item') {
                                        let items = [];
                                        if (Array.isArray(block.items)) {
                                            items = block.items;
                                        } else if (Array.isArray(block.children)) {
                                            items = block.children.map(it => (typeof it === 'string') ? it : (it && (it.text || it.content) || ''));
                                        } else if (Array.isArray(block.lines)) {
                                            items = block.lines;
                                        } else if (typeof block.text === 'string' && block.text.includes('\n')) {
                                            items = block.text.split('\n');
                                        } else if (typeof block.text === 'string') {
                                            items = [block.text];
                                        }

                                        const isOrdered = type === 'ordered' || type === 'numbered' || !!block.ordered;
                                        items.forEach((rawItem, liIndex) => {
                                            const itemText = (typeof rawItem === 'string') ? rawItem : (rawItem && (rawItem.text || rawItem.content) || '');
                                            const clean = String(itemText).trim();
                                            if (!clean) return;
                                            const prefix = isOrdered ? `${liIndex + 1}. ` : '‚Ä¢ ';
                                            const li = new fabric.Textbox(prefix + clean, {
                                                left: 70,
                                                top: currentY,
                                                fontSize: 12,
                                                fontFamily: 'Arial',
                                                fill: '#111827',
                                                width: 480,
                                                editable: true
                                            });
                                            fabricCanvas.add(li);
                                            currentY += li.height + 6;
                                            totalObjects++;
                                        });
                                    }
                                    else if (type === 'table' || (block.data && Array.isArray(block.data))) {
                                        const data = Array.isArray(block.data) ? block.data : (Array.isArray(block.rows) ? block.rows : []);
                                        if (data.length > 0) {
                                            currentY += 10;
                                            const title = new fabric.Text(`Table ${bIndex + 1}` , {
                                                left: 50,
                                                top: currentY,
                                                fontSize: 11,
                                                fill: '#3b82f6',
                                                fontFamily: 'Arial',
                                                fontWeight: 'bold',
                                                selectable: false
                                            });
                                            fabricCanvas.add(title);
                                            currentY += 20;

                                            const cellWidth = 120;
                                            const cellHeight = 25;
                                            const startX = 50;
                                            data.forEach((row, rowIndex) => {
                                                const rowY = currentY + (rowIndex * cellHeight);
                                                (row || []).forEach((cell, colIndex) => {
                                                    const cellX = startX + (colIndex * cellWidth);
                                                    const cellRect = new fabric.Rect({
                                                        left: cellX,
                                                        top: rowY,
                                                        width: cellWidth,
                                                        height: cellHeight,
                                                        fill: rowIndex === 0 ? '#f3f4f6' : '#ffffff',
                                                        stroke: '#e5e7eb',
                                                        strokeWidth: 1,
                                                        selectable: false
                                                    });
                                                    fabricCanvas.add(cellRect);
                                                    const cellVal = (typeof cell === 'string') ? cell : (cell && (cell.text || cell.value)) || '';
                                                    if (String(cellVal).trim()) {
                                                        const cellText = new fabric.Text(String(cellVal), {
                                                            left: cellX + 5,
                                                            top: rowY + 5,
                                                            fontSize: 10,
                                                            fontFamily: 'Arial',
                                                            fill: '#111827',
                                                            width: cellWidth - 10,
                                                            fontWeight: rowIndex === 0 ? 'bold' : 'normal',
                                                            selectable: false
                                                        });
                                                        fabricCanvas.add(cellText);
                                                    }
                                                    totalObjects += 2;
                                                });
                                            });
                                            currentY += (data.length * cellHeight) + 20;
                                        }
                                    }
                                    else if (type === 'image' || block.image || block.image_data || block.src) {
                                        const src = block.image_data || block.src || (block.image && block.image.data);
                                        if (src) {
                                            const url = src.startsWith('data:') ? src : `data:image/png;base64,${src}`;
                                            fabric.Image.fromURL(url, function(img) {
                                                img.set({ left: 50, top: currentY, scaleX: 0.5, scaleY: 0.5, selectable: true });
                                                fabricCanvas.add(img);
                                                fabricCanvas.requestRenderAll();
                                            });
                                            currentY += 180;
                                            totalObjects++;
                                        }
                                    }
                                });
                            } else {
                                if (page.text && page.text.trim()) {
                                    const lines = page.text.split('\n');
                                    lines.forEach((line) => {
                                        if (line.trim()) {
                                            const textObj = new fabric.IText(line, {
                                                left: 50,
                                                top: currentY,
                                                fontSize: 12,
                                                fontFamily: 'Arial',
                                                fill: '#111827',
                                                selectable: true,
                                                editable: true,
                                                width: 500
                                            });
                                            fabricCanvas.add(textObj);
                                            currentY += 20;
                                            totalObjects++;
                                        }
                                    });
                                }

                                if (page.tables && page.tables.length > 0) {
                                    console.log(`  üìä ${page.tables.length} table(s)`);
                                    page.tables.forEach((table, tableIndex) => {
                                        currentY += 20;
                                        const tableTitle = new fabric.Text(`Table ${tableIndex + 1}`, {
                                            left: 50,
                                            top: currentY,
                                            fontSize: 11,
                                            fill: '#3b82f6',
                                            fontFamily: 'Arial',
                                            fontWeight: 'bold',
                                            selectable: false
                                        });
                                        fabricCanvas.add(tableTitle);
                                        currentY += 25;
                                        if (table.data && Array.isArray(table.data)) {
                                            const cellWidth = 120;
                                            const cellHeight = 25;
                                            const startX = 50;
                                            table.data.forEach((row, rowIndex) => {
                                                const rowY = currentY + (rowIndex * cellHeight);
                                                row.forEach((cell, colIndex) => {
                                                    const cellX = startX + (colIndex * cellWidth);
                                                    const cellRect = new fabric.Rect({
                                                        left: cellX,
                                                        top: rowY,
                                                        width: cellWidth,
                                                        height: cellHeight,
                                                        fill: rowIndex === 0 ? '#f3f4f6' : '#ffffff',
                                                        stroke: '#e5e7eb',
                                                        strokeWidth: 1,
                                                        selectable: false
                                                    });
                                                    fabricCanvas.add(cellRect);
                                                    if (cell && (typeof cell !== 'object' ? String(cell).trim() : (cell.text||'').trim())) {
                                                        const txt = typeof cell === 'object' ? (cell.text||'') : String(cell);
                                                        const cellText = new fabric.Text(txt, {
                                                            left: cellX + 5,
                                                            top: rowY + 5,
                                                            fontSize: 10,
                                                            fontFamily: 'Arial',
                                                            fill: '#111827',
                                                            width: cellWidth - 10,
                                                            fontWeight: rowIndex === 0 ? 'bold' : 'normal',
                                                            selectable: false
                                                        });
                                                        fabricCanvas.add(cellText);
                                                    }
                                                    totalObjects += 2;
                                                });
                                            });
                                            currentY += (table.data.length * cellHeight) + 20;
                                        }
                                    });
                                }

                                if (Array.isArray(page.images) && page.images.length > 0) {
                                    page.images.forEach((imgObj) => {
                                        const src = imgObj.data || imgObj.base64 || imgObj.src;
                                        if (src) {
                                            const url = (src.startsWith && src.startsWith('data:')) ? src : `data:image/png;base64,${src}`;
                                            fabric.Image.fromURL(url, function(img) {
                                                img.set({ left: 50, top: currentY, scaleX: 0.5, scaleY: 0.5, selectable: true });
                                                fabricCanvas.add(img);
                                                fabricCanvas.requestRenderAll();
                                            });
                                            currentY += 180;
                                            totalObjects++;
                                        }
                                    });
                                }
                            }
                            
                            currentY += pageMargin;
                            const separator = new fabric.Line([50, currentY - 30, 545, currentY - 30], {
                                stroke: '#e5e7eb',
                                strokeWidth: 2,
                                strokeDashArray: [5, 5],
                                selectable: false
                            });
                            fabricCanvas.add(separator);
                        });
                        
                        fabricCanvas.setHeight(currentY + 100);
                        fabricCanvas.setWidth(content.pages[0] ? content.pages[0].width + 100 : 695);
                        fabricCanvas.renderAll();
                        
                        console.log(`‚úÖ ${totalObjects} objects created from ${content.pages.length} pages`);
                        showSaveIndicator(`${content.pages.length} pages charg√©es`, 'saved');
                        setTimeout(() => hideSaveIndicator(), 2000);
                        updateCanvasStats();
                    }
                    else {
                        console.warn('‚ö†Ô∏è Unknown content, creating blank canvas.');
                        createBlankCanvas();
                    }
                } else {
                    console.warn('‚ö†Ô∏è Server error, creating blank canvas. Error:', response.error);
                    createBlankCanvas();
                }
            },
            error: function(xhr) {
                console.error('AJAX Error:', xhr);
                createBlankCanvas();
            }
        });
    }

    function setupEventListeners() {
        $('.sidebar-tab').on('click', function() {
            const tab = $(this).data('tab');
            $('.sidebar-tab').removeClass('active');
            $(this).addClass('active');
            $('.sidebar-tab-panel').removeClass('active');
            $('#' + tab + 'Panel').addClass('active');
        });

        $('.mode-btn').on('click', function() {
            const mode = $(this).data('mode');
            switchEditorMode(mode);
        });

        $('#saveBtn').on('click', saveDocument);
        $('#exportBtn').on('click', exportDocument);
        $('#reloadBtn').on('click', reloadEditorContent);
        $('#undoBtn').on('click', () => quillEditor.history.undo());
        $('#redoBtn').on('click', () => quillEditor.history.redo());

        $('#agentSendBtn').on('click', sendAgentMessage);
        $('#agentInput').on('keydown', function(e) {
            if (e.ctrlKey && e.keyCode === 13) {
                sendAgentMessage();
            }
        });

        $('#textColorPicker').on('change', function() {
            const color = $(this).val();
            $('#textColorInput').val(color);
            quillEditor.format('color', color);
        });

        $('#fontSizeInput').on('change', function() {
            const size = $(this).val() + 'px';
            quillEditor.format('size', size);
        });

        $('#fontSelect').on('change', function() {
            const font = $(this).val();
            quillEditor.format('font', font);
        });

        $('#insertImageBtn').on('click', () => $('#imageUpload').click());
        $('#imageUpload').on('change', handleImageUpload);

        $('#docTitleInput').on('change', function() {
            $('#documentTitle').text($(this).val());
        });

        $('#addTextBtn').on('click', addTextToCanvas);
        $('#addRectBtn').on('click', addRectToCanvas);
        $('#addCircleBtn').on('click', addCircleToCanvas);
        $('#addLineBtn').on('click', addLineToCanvas);
        $('#deleteObjectBtn').on('click', deleteSelectedObject);

        $('#objLeftInput').on('change', updateObjectPosition);
        $('#objTopInput').on('change', updateObjectPosition);
        $('#objWidthInput').on('change', updateObjectSize);
        $('#objHeightInput').on('change', updateObjectSize);
        $('#objAngleInput').on('change', updateObjectRotation);
        $('#objOpacityInput').on('change', updateObjectOpacity);
    }

    function switchEditorMode(mode) {
        $('.mode-btn').removeClass('active');
        $('.mode-btn[data-mode="' + mode + '"]').addClass('active');

        if (mode === 'text') {
            if (currentMode === 'visual') {
                convertFabricToQuill();
            }

            $('#textEditorContainer').show();
            $('#visualEditorContainer').removeClass('active');
            currentMode = 'text';

            $('#insertionSection').show();
            $('#visualToolsSection').hide();
            $('#objectPropertiesSection').hide();

            updateStats();
        } else {
            $('#textEditorContainer').hide();
            $('#visualEditorContainer').addClass('active');
            currentMode = 'visual';

            $('#insertionSection').hide();
            $('#visualToolsSection').show();

            loadVisualContent();
        }
    }

    function convertQuillToFabric() {
        fabricCanvas.clear();

        const delta = quillEditor.getContents();
        const ops = delta.ops || [];

        let currentY = 50;
        let currentX = 50;
        const pageWidth = 800;
        const lineHeight = 25;
        const maxWidth = pageWidth - 100;

        ops.forEach((op, index) => {
            if (typeof op.insert === 'string') {
                const text = op.insert;
                const attrs = op.attributes || {};

                if (text === '\n') {
                    currentY += lineHeight;
                    currentX = 50;
                    return;
                }

                const lines = text.split('\n');

                lines.forEach((line, lineIndex) => {
                    if (line.trim()) {
                        const fontSize = attrs.size ? parseInt(attrs.size.replace('px', '')) : 14;
                        const fontFamily = attrs.font || 'Arial';
                        const fontWeight = attrs.bold ? 'bold' : 'normal';
                        const fontStyle = attrs.italic ? 'italic' : 'normal';
                        const fill = attrs.color || '#111827';
                        const backgroundColor = attrs.background || 'transparent';

                        const fabricText = new fabric.Textbox(line, {
                            left: currentX,
                            top: currentY,
                            width: maxWidth,
                            fontSize: fontSize,
                            fontFamily: fontFamily,
                            fontWeight: fontWeight,
                            fontStyle: fontStyle,
                            fill: fill,
                            backgroundColor: backgroundColor,
                            textAlign: attrs.align || 'left',
                            underline: attrs.underline || false,
                            linethrough: attrs.strike || false,
                            editable: true,
                            selectable: true
                        });

                        fabricCanvas.add(fabricText);
                        currentY += fabricText.height + 10;
                    }

                    if (lineIndex < lines.length - 1) {
                        currentY += lineHeight;
                        currentX = 50;
                    }
                });
            } else if (op.insert && op.insert.image) {
                fabric.Image.fromURL(op.insert.image, function(img) {
                    img.set({
                        left: currentX,
                        top: currentY,
                        scaleX: 0.5,
                        scaleY: 0.5
                    });
                    fabricCanvas.add(img);
                    fabricCanvas.renderAll();
                });

                currentY += 200;
            }
        });

        fabricCanvas.renderAll();
        updateCanvasStats();
    }

    function convertFabricToQuill() {
        const objects = fabricCanvas.getObjects();
        const ops = [];

        objects.sort((a, b) => {
            if (Math.abs(a.top - b.top) < 10) {
                return a.left - b.left;
            }
            return a.top - b.top;
        });

        objects.forEach((obj, index) => {
            if (obj.type === 'textbox' || obj.type === 'text') {
                const attributes = {};

                if (obj.fontSize !== 14) {
                    attributes.size = obj.fontSize + 'px';
                }
                if (obj.fontFamily && obj.fontFamily !== 'Arial') {
                    attributes.font = obj.fontFamily;
                }
                if (obj.fontWeight === 'bold') {
                    attributes.bold = true;
                }
                if (obj.fontStyle === 'italic') {
                    attributes.italic = true;
                }
                if (obj.fill !== '#111827') {
                    attributes.color = obj.fill;
                }
                if (obj.backgroundColor && obj.backgroundColor !== 'transparent') {
                    attributes.background = obj.backgroundColor;
                }
                if (obj.textAlign && obj.textAlign !== 'left') {
                    attributes.align = obj.textAlign;
                }
                if (obj.underline) {
                    attributes.underline = true;
                }
                if (obj.linethrough) {
                    attributes.strike = true;
                }

                ops.push({
                    insert: obj.text,
                    attributes: Object.keys(attributes).length > 0 ? attributes : undefined
                });

                ops.push({ insert: '\n' });

            } else if (obj.type === 'image') {
                ops.push({
                    insert: { image: obj.getSrc() }
                });
                ops.push({ insert: '\n' });
            }
        });

        if (ops.length > 0) {
            quillEditor.setContents({ ops: ops });
            updateStats();
        }
    }

    function saveDocument() {
        showSaveIndicator('Sauvegarde...', 'saving');

        const content = currentMode === 'text'
            ? quillEditor.getContents()
            : fabricCanvas.toJSON();

        $.ajax({
            url: URL_SAVE,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: CSRF_TOKEN,
                content_type: currentMode === 'text' ? 'quill' : 'fabric',
                content_data: JSON.stringify(content),
                conversation_id: conversationId
            },
            success: function(response) {
                if (response.success) {
                    showSaveIndicator('‚úì Sauvegard√©', 'saved');
                    setTimeout(() => hideSaveIndicator(), 3000);
                } else {
                    showSaveIndicator('Erreur: ' + response.error, 'error');
                }
            },
            error: function(xhr) {
                showSaveIndicator('Erreur de sauvegarde', 'error');
            }
        });
    }

    function startAutoSave() {
        autoSaveInterval = setInterval(function() {
            autoSaveDocument();
        }, 30000);
    }

    function reloadEditorContent() {
        console.log('üîÑ Rechargement...');

        if (currentMode === 'visual') {
            loadVisualContent();
        } else {
            loadDocumentContent();
        }
    }

    window.reloadEditorContent = reloadEditorContent;

    function autoSaveDocument() {
        const content = currentMode === 'text'
            ? quillEditor.getContents()
            : fabricCanvas.toJSON();

        $.ajax({
            url: URL_AUTOSAVE,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: CSRF_TOKEN,
                content_type: currentMode === 'text' ? 'quill' : 'fabric',
                content_data: JSON.stringify(content)
            },
            success: function(response) {
                console.log('Auto-sauvegarde');
            }
        });
    }

    function exportDocument() {
        const format = prompt('Format d\'export:\n- pdf\n- html\n- txt', 'pdf');
        if (!format) return;

        const content = currentMode === 'text'
            ? quillEditor.getContents()
            : fabricCanvas.toJSON();

        const form = $('<form>', {
            method: 'POST',
            action: '/chat/editor/' + documentId + '/export/'
        });

        form.append($('<input>', {
            type: 'hidden',
            name: 'csrfmiddlewaretoken',
            value: CSRF_TOKEN
        }));

        form.append($('<input>', {
            type: 'hidden',
            name: 'format',
            value: format
        }));

        form.append($('<input>', {
            type: 'hidden',
            name: 'content_type',
            value: currentMode === 'text' ? 'quill' : 'fabric'
        }));

        form.append($('<input>', {
            type: 'hidden',
            name: 'content_data',
            value: JSON.stringify(content)
        }));

        $('body').append(form);
        form.submit();
        form.remove();
    }

    function sendAgentMessage() {
        const message = $('#agentInput').val().trim();
        if (!message) return;

        $('#agentChat').append(
            '<div class="agent-message" style="background: var(--accent-primary); color: white; border-left-color: var(--accent-hover);">' +
                '<strong style="color: white;">Vous</strong>' +
                '<p style="margin: 5px 0 0 0; font-size: 0.9rem;">' + escapeHtml(message) + '</p>' +
            '</div>'
        );

        $('#agentInput').val('');
        scrollAgentChat();

        $.ajax({
            url: URL_SEND_MESSAGE,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: CSRF_TOKEN,
                content: message
            },
            success: function(response) {
                if (response.success) {
                    $('#agentChat').append(
                        '<div class="agent-message">' +
                            '<strong style="color: var(--accent-primary);">ü§ñ DocMind</strong>' +
                            '<p style="margin: 5px 0 0 0; font-size: 0.9rem;">' +
                            escapeHtml(response.assistant_message.content) + '</p>' +
                        '</div>'
                    );
                    scrollAgentChat();

                    if (response.assistant_message.generated_files &&
                        response.assistant_message.generated_files.length > 0) {
                        loadDocumentContent();
                    }
                }
            }
        });
    }

    function scrollAgentChat() {
        const chat = document.getElementById('agentChat');
        chat.scrollTop = chat.scrollHeight;
    }

    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const dataUrl = event.target.result;

            if (currentMode === 'text') {
                const range = quillEditor.getSelection(true);
                quillEditor.insertEmbed(range.index, 'image', dataUrl);
            } else {
                fabric.Image.fromURL(dataUrl, function(img) {
                    img.scale(0.5);
                    fabricCanvas.add(img);
                    fabricCanvas.renderAll();
                });
            }
        };
        reader.readAsDataURL(file);
    }

    function loadDocument(docId) {
        window.location.href = '/chat/conversation/' + conversationId + '/editor/' + docId + '/';
    }

    function addTextToCanvas() {
        const text = new fabric.Textbox('Nouveau texte', {
            left: 100,
            top: 100,
            width: 200,
            fontSize: 16,
            fill: '#111827',
            fontFamily: 'Arial',
            editable: true,
            selectable: true
        });
        fabricCanvas.add(text);
        fabricCanvas.setActiveObject(text);
        fabricCanvas.renderAll();
    }

    function addRectToCanvas() {
        const rect = new fabric.Rect({
            left: 100,
            top: 100,
            width: 150,
            height: 100,
            fill: '#3b82f6',
            stroke: '#2563eb',
            strokeWidth: 2
        });
        fabricCanvas.add(rect);
        fabricCanvas.setActiveObject(rect);
        fabricCanvas.renderAll();
    }

    function addCircleToCanvas() {
        const circle = new fabric.Circle({
            left: 100,
            top: 100,
            radius: 50,
            fill: '#10b981',
            stroke: '#059669',
            strokeWidth: 2
        });
        fabricCanvas.add(circle);
        fabricCanvas.setActiveObject(circle);
        fabricCanvas.renderAll();
    }

    function addLineToCanvas() {
        const line = new fabric.Line([50, 50, 200, 50], {
            stroke: '#3b82f6',
            strokeWidth: 3,
            left: 100,
            top: 100
        });
        fabricCanvas.add(line);
        fabricCanvas.setActiveObject(line);
        fabricCanvas.renderAll();
    }

    function deleteSelectedObject() {
        const activeObject = fabricCanvas.getActiveObject();
        if (activeObject) {
            if (confirm('Supprimer cet objet ?')) {
                fabricCanvas.remove(activeObject);
                fabricCanvas.renderAll();
            }
        } else {
            alert('Veuillez s√©lectionner un objet √† supprimer.');
        }
    }

    function showObjectProperties(obj) {
        if (!obj) return;

        $('#objectPropertiesSection').show();

        $('#objLeftInput').val(Math.round(obj.left));
        $('#objTopInput').val(Math.round(obj.top));

        if (obj.width) {
            $('#objWidthInput').val(Math.round(obj.width * (obj.scaleX || 1)));
        }
        if (obj.height) {
            $('#objHeightInput').val(Math.round(obj.height * (obj.scaleY || 1)));
        }
        if (obj.radius) {
            $('#objWidthInput').val(Math.round(obj.radius * 2 * (obj.scaleX || 1)));
            $('#objHeightInput').val(Math.round(obj.radius * 2 * (obj.scaleY || 1)));
        }

        $('#objAngleInput').val(Math.round(obj.angle || 0));
        $('#objOpacityInput').val(Math.round((obj.opacity || 1) * 100));
    }

    function hideObjectProperties() {
        $('#objectPropertiesSection').hide();
    }

    function updateObjectPosition() {
        const obj = fabricCanvas.getActiveObject();
        if (obj) {
            obj.set({
                left: parseInt($('#objLeftInput').val()),
                top: parseInt($('#objTopInput').val())
            });
            fabricCanvas.renderAll();
        }
    }

    function updateObjectSize() {
        const obj = fabricCanvas.getActiveObject();
        if (obj) {
            const newWidth = parseInt($('#objWidthInput').val());
            const newHeight = parseInt($('#objHeightInput').val());

            if (obj.type === 'rect' || obj.type === 'textbox') {
                obj.set({
                    width: newWidth,
                    height: newHeight,
                    scaleX: 1,
                    scaleY: 1
                });
            } else if (obj.type === 'circle') {
                obj.set({
                    radius: Math.min(newWidth, newHeight) / 2,
                    scaleX: 1,
                    scaleY: 1
                });
            }
            fabricCanvas.renderAll();
        }
    }

    function updateObjectRotation() {
        const obj = fabricCanvas.getActiveObject();
        if (obj) {
            obj.set('angle', parseInt($('#objAngleInput').val()));
            fabricCanvas.renderAll();
        }
    }

    function updateObjectOpacity() {
        const obj = fabricCanvas.getActiveObject();
        if (obj) {
            obj.set('opacity', parseInt($('#objOpacityInput').val()) / 100);
            fabricCanvas.renderAll();
        }
    }

    window.addEventListener('beforeunload', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });
});
</script>
{% endverbatim %}
{% endblock %}
